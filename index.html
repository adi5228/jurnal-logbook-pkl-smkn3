<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sistem Logbook PKL</title>
  
  <style>
    /* --- STYLING KHUSUS UNTUK LAYAR LOADING AWAL --- */
    body { 
      font-family: 'Segoe UI', sans-serif; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      height: 100vh; 
      margin: 0; 
      background: #f0f2f5; 
      flex-direction: column;
    }
    
    /* Animasi Spinner Putar */
    .loader { 
      border: 5px solid #e0e0e0; 
      border-top: 5px solid #0d6efd; 
      border-radius: 50%; 
      width: 50px; 
      height: 50px; 
      animation: spin 1s linear infinite; 
      margin-bottom: 15px;
    }
    
    .loading-text { 
      color: #6c757d; 
      font-weight: 600; 
      font-size: 0.9rem;
      letter-spacing: 0.5px;
    }

    /* Tampilan Error (Disembunyikan secara default) */
    #error-msg {
      display: none;
      color: #dc3545;
      text-align: center;
      max-width: 80%;
      margin-top: 20px;
      padding: 15px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
  
  <script>
    /**
     * Saat halaman pertama kali dimuat, jalankan fungsi router ini.
     */
    window.onload = function() {
      // 1. Cek Parameter URL (Contoh: url_aplikasi?page=supervisor)
      const urlParams = new URLSearchParams(window.location.search);
      const pageParam = urlParams.get('page');

      // 2. Cek Data Sesi Lokal (LocalStorage) di browser pengguna
      const token = localStorage.getItem('sessionToken');
      const role = localStorage.getItem('userRole');

      // ==========================================
      // --- LOGIKA ROUTING HALAMAN ---
      // ==========================================

      // KASUS A: Ada Parameter di URL (Prioritas Tertinggi)
      // Biasanya ini terjadi ketika user dialihkan (redirect) paksa oleh sistem
      if (pageParam === 'supervisor') {
         loadPage('supervisor_dashboard');
         return;
      }
      
      if (pageParam === 'admin') {
         // Verifikasi ekstra: Pastikan yang mengakses URL admin benar-benar memiliki sesi ADMIN
         if(token && role === 'ADMIN') {
            loadPage('admin');
         } else {
            // Jika coba akses URL admin tapi bukan admin, lempar kembali ke halaman login
            loadPage('login');
         }
         return;
      }

      // KASUS B: Tidak Ada Parameter URL, Tapi Ada Sesi Tersimpan (Auto-Login)
      if (token) {
         // Jika tokennya adalah token khusus pembimbing
         if (token === 'SUPERVISOR_ACCESS') {
            loadPage('supervisor_dashboard');
            return;
         }
         
         // Jika token milik siswa
         if (role === 'SISWA') {
            loadPage('student_dashboard');
            return;
         }
         
         // Jika token milik guru
         if (role === 'GURU') {
            loadPage('teacher_dashboard');
            return;
         }
         
         // Jika token milik admin
         if (role === 'ADMIN') {
            loadPage('admin');
            return;
         }
      }

      // KASUS C: Default (Belum Login atau Sesi Tidak Valid)
      // Tampilkan halaman form login
      loadPage('login');
    };

    /**
     * Meminta server Google Apps Script untuk mengambil konten HTML dari file tertentu.
     * Menggunakan fungsi 'include' yang ada di Code.gs.
     * @param {string} pageName - Nama file HTML yang ingin dimuat (tanpa ekstensi .html)
     */
    function loadPage(pageName) {
      console.log("Memuat halaman: " + pageName);
      
      // Panggil server (Code.gs)
      google.script.run
        .withSuccessHandler(renderPage) // Jika sukses, jalankan renderPage
        .withFailureHandler(showError)  // Jika gagal (internet putus/server error), jalankan showError
        .include(pageName);
    }

    /**
     * Mengganti seluruh isi halaman saat ini (Layar Loading) 
     * dengan HTML asli dari halaman yang diminta (Teknik Single Page Application).
     * @param {string} html - String konten HTML mentah dari server
     */
    function renderPage(html) {
      document.open();
      document.write(html);
      document.close();
    }

    /**
     * Menampilkan pesan error di layar jika koneksi ke server Apps Script gagal.
     * Terdapat tombol "Reset & Reload" untuk membersihkan cache/sesi yang mungkin korup.
     * @param {Error} err - Objek error dari sistem
     */
    function showError(err) {
      // Sembunyikan animasi loading
      document.querySelector('.loader').style.display = 'none';
      document.querySelector('.loading-text').style.display = 'none';
      
      // Tampilkan kotak pesan error
      const msg = document.getElementById('error-msg');
      msg.style.display = 'block';
      msg.innerHTML = `
        <h4 style="margin:0 0 10px;">Gagal Memuat Sistem</h4>
        <div style="font-size:0.85rem; color:#555;">${err.message}</div>
        
        <button onclick="localStorage.clear(); window.top.location.href=window.location.href.split('?')[0];" 
            style="margin-top:15px; padding:8px 15px; background:#dc3545; color:white; border:none; border-radius:4px; cursor:pointer;">
            Reset & Reload Aplikasi
        </button>
      `;
    }
  </script>
</head>
<body>
  
  <div class="loader"></div>
  <div class="loading-text">Menyiapkan Aplikasi...</div>
  
  <div id="error-msg"></div>

</body>
</html>

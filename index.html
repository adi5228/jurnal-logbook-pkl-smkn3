<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sistem Logbook PKL</title>
  
  <style>
    body { 
      font-family: 'Segoe UI', sans-serif; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      height: 100vh; 
      margin: 0; 
      background: #f0f2f5; 
      flex-direction: column;
    }
    
    .loader { 
      border: 5px solid #e0e0e0; 
      border-top: 5px solid #0d6efd; 
      border-radius: 50%; 
      width: 50px; 
      height: 50px; 
      animation: spin 1s linear infinite; 
      margin-bottom: 15px;
    }
    
    .loading-text { 
      color: #6c757d; 
      font-weight: 600; 
      font-size: 0.9rem;
      letter-spacing: 0.5px;
    }

    /* Error Display Styling */
    #error-msg {
      display: none;
      color: #dc3545;
      text-align: center;
      max-width: 80%;
      margin-top: 20px;
      padding: 15px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
  
  <script>
    /**
     * MAIN ENTRY POINT
     * Determines which page to load based on URL parameters or LocalStorage session.
     */
    window.onload = function() {
      // 1. Get URL Parameters (e.g., ?page=supervisor)
      const urlParams = new URLSearchParams(window.location.search);
      const pageParam = urlParams.get('page');

      // 2. Get Local Session Data
      const token = localStorage.getItem('sessionToken');
      const role = localStorage.getItem('userRole');

      // --- ROUTING LOGIC ---

      // CASE A: URL Parameter exists (Highest Priority)
      // Handles redirection from server-side logic
      if (pageParam === 'supervisor') {
          loadPage('supervisor_dashboard');
          return;
      }
      
      if (pageParam === 'admin') {
          // Security Check: Ensure local token matches admin role
          if(token && role === 'ADMIN') {
             loadPage('admin');
          } else {
             // If trying to access admin without session, redirect to login
             loadPage('login');
          }
          return;
      }

      // CASE B: No URL Parameter, but Valid Session exists (Auto-Login)
      if (token) {
          if (token === 'SUPERVISOR_ACCESS') {
             loadPage('supervisor_dashboard');
             return;
          }
          
          if (role === 'SISWA') {
             loadPage('student_dashboard');
             return;
          }
          
          if (role === 'GURU') {
             loadPage('teacher_dashboard');
             return;
          }
          
          if (role === 'ADMIN') {
             loadPage('admin');
             return;
          }
      }

      // CASE C: Default Fallback (No Session / Invalid Session)
      loadPage('login');
    };

    /**
     * Helper: Request Server to Render HTML Page
     * Calls Google Apps Script 'include' function.
     */
    function loadPage(pageName) {
      console.log("Loading page: " + pageName);
      google.script.run
        .withSuccessHandler(renderPage)
        .withFailureHandler(showError)
        .include(pageName);
    }

    /**
     * Helper: Replace Current Document Content
     * Replaces the loading screen with the fetched HTML content.
     */
    function renderPage(html) {
      document.open();
      document.write(html);
      document.close();
    }

    /**
     * Helper: Display Error Message
     * Shows a reset button if loading fails.
     */
    function showError(err) {
      document.querySelector('.loader').style.display = 'none';
      document.querySelector('.loading-text').style.display = 'none';
      
      const msg = document.getElementById('error-msg');
      msg.style.display = 'block';
      msg.innerHTML = `
        <h4 style="margin:0 0 10px;">Gagal Memuat Sistem</h4>
        <div style="font-size:0.85rem; color:#555;">${err.message}</div>
        <button onclick="localStorage.clear(); window.top.location.href=window.location.href.split('?')[0];" 
           style="margin-top:15px; padding:8px 15px; background:#dc3545; color:white; border:none; border-radius:4px; cursor:pointer;">
           Reset & Reload
        </button>
      `;
    }
  </script>
</head>
<body>
  <div class="loader"></div>
  <div class="loading-text">Menyiapkan Aplikasi...</div>
  
  <div id="error-msg"></div>
</body>
</html>
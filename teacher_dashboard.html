<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Dashboard Guru</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <style>
    /* ========================================================================
       GLOBAL & MAIN LAYOUT STYLES
       ======================================================================== */
    body { 
        background-color: #f0f2f5; 
        height: 100vh; 
        overflow: hidden; /* Mencegah body scrolling, scroll ditangani oleh elemen anak */
        display: flex; 
        flex-direction: column; 
        font-family: 'Segoe UI', sans-serif; 
    }
    
    .navbar { flex-shrink: 0; z-index: 1060; } 
    
    .main-layout { 
        display: flex; 
        flex: 1; 
        overflow: hidden; 
        position: relative; 
    }
    
    /* ========================================================================
       SIDEBAR STYLES (Daftar Siswa Bimbingan)
       ======================================================================== */
    .sidebar { 
        width: 300px; 
        background: white; 
        border-right: 1px solid #ddd; 
        overflow-y: auto; 
        display: flex; 
        flex-direction: column; 
        transition: transform 0.3s ease-in-out;
    }
    
    .student-item { 
        padding: 15px; 
        border-bottom: 1px solid #f0f0f0; 
        cursor: pointer; 
        transition: 0.2s; 
    }
    .student-item:hover { background: #f8f9fa; }
    
    /* Highlight untuk siswa yang sedang dipilih */
    .student-item.active { 
        background: #e8f4fd; 
        border-left: 4px solid #0d6efd; 
    }
    
    /* ========================================================================
       CONTENT AREA STYLES (Area Menampilkan Logbook)
       ======================================================================== */
    .content { 
        flex: 1; 
        padding: 20px; 
        overflow-y: auto; 
        background: #f0f2f5; 
        position: relative;
        /* Flexbox agar footer bisa didorong ke bawah (sticky bottom) */
        display: flex;
        flex-direction: column; 
    }
    
    .log-card { 
        background: white; 
        border-radius: 8px; 
        padding: 20px; 
        margin-bottom: 20px; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
    }
    
    /* ========================================================================
       CUSTOM UI ELEMENTS
       ======================================================================== */
    /* Select Dropdown khusus di Navbar (Filter Tahun) */
    .nav-select {
        background-color: rgba(255,255,255,0.1); 
        color: white; 
        border: 1px solid rgba(255,255,255,0.2);
        font-weight: bold;
    }
    .nav-select:focus { 
        background-color: rgba(255,255,255,0.2); 
        color: white; 
        box-shadow: none; 
        border-color: rgba(255,255,255,0.5); 
    }
    .nav-select option { color: #333; background: white; } 

    /* Footer Styling Khusus Dashboard Guru */
    .app-footer {
        text-align: center;
        padding: 25px 10px;
        color: #adb5bd;
        font-size: 0.75rem;
        font-weight: 500;
        margin-top: auto; /* Kunci agar footer selalu di bawah konten */
        width: 100%;
        border-top: 1px solid #e9ecef;
    }

    /* ========================================================================
       MOBILE RESPONSIVE TWEAKS (Layar <= 768px)
       ======================================================================== */
    @media (max-width: 768px) {
      /* Sidebar berubah menjadi mode 'Drawer/Offcanvas' di Mobile */
      .sidebar {
         position: fixed; top: 0; left: 0; bottom: 0;
         width: 85%; 
         max-width: 300px;
         z-index: 1050;
         transform: translateX(-100%); /* Disembunyikan ke kiri secara default */
         box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      }
      .sidebar.show { transform: translateX(0); /* Munculkan sidebar */ } 
      
      .content { width: 100%; padding: 15px; }
      
      /* Background redup (overlay) saat sidebar mobile terbuka */
      .sidebar-overlay {
         display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
         background: rgba(0,0,0,0.5); z-index: 1040;
      }
      .sidebar-overlay.show { display: block; }
    }
  </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark px-3 shadow sticky-top">
  <div class="d-flex align-items-center w-100">
      
      <button class="btn btn-sm btn-outline-light me-2 d-md-none border-0" onclick="toggleSidebar()">
         <i class="bi bi-list fs-5"></i>
      </button>
      
      <select id="filterTahun" class="form-select form-select-sm w-auto nav-select me-2" onchange="loadMyStudents()">
         <option value="">Thn...</option>
      </select>

      <span class="navbar-brand mb-0 h1 fs-6 d-none d-md-block text-truncate me-auto">
        <i class="bi bi-person-workspace me-2"></i> 
        <span id="guruName">Memuat...</span>
      </span>

      <button onclick="changePassGuru()" class="btn btn-sm btn-outline-light me-2 fw-bold" title="Ganti Password">
         <i class="bi bi-key-fill"></i>
      </button>

      <button onclick="logout()" class="btn btn-sm btn-danger fw-bold">Keluar</button>
  </div>
</nav>

<div class="main-layout">
  
  <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

  <div class="sidebar" id="mySidebar">
    <div class="p-3 bg-light border-bottom sticky-top d-flex justify-content-between align-items-center">
         <h6 class="m-0 fw-bold text-dark"><i class="bi bi-people-fill me-2"></i>DAFTAR SISWA</h6>
         <button class="btn btn-sm btn-close d-md-none" onclick="toggleSidebar()"></button>
    </div>
    
    <div id="studentList">
      <div class="text-center py-4 text-muted"><span class="spinner-border spinner-border-sm"></span></div>
    </div>
  </div>
  
  <div class="content">
    
    <div id="emptyState" class="text-center text-muted mt-5 flex-grow-1">
      <h4>ðŸ‘‹ Selamat Datang</h4>
      <p>Buka menu daftar siswa untuk mulai memeriksa jurnal/logbook.</p>
      <button class="btn btn-primary d-md-none mt-3 shadow-sm" onclick="toggleSidebar()">
          <i class="bi bi-list"></i> Buka Daftar Siswa
      </button>
    </div>
    
    <div id="logContainer" style="display: none; flex-grow: 1;">
      <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
          <button class="btn btn-sm btn-light border me-2 d-md-none shadow-sm" onclick="backToEmpty()"><i class="bi bi-arrow-left"></i></button>
          <div>
              <small class="text-muted d-block lh-1">Logbook Siswa:</small>
              <h5 class="m-0 fw-bold text-primary" id="selectedStudent">...</h5>
          </div>
      </div>
      
      <div id="logsArea"></div>
    </div>

    <div class="app-footer">
        &copy; KP Informatika UHO 2026
    </div>

  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Mengambil token sesi dari LocalStorage
  const token = localStorage.getItem('sessionToken');
  let currentStudentNisn = null; // Menyimpan NISN siswa yang sedang dilihat logbooknya

  /**
   * Menangani toggle (buka/tutup) Sidebar pada layar perangkat mobile.
   */
  function toggleSidebar() {
      document.getElementById('mySidebar').classList.toggle('show');
      document.getElementById('sidebarOverlay').classList.toggle('show');
  }

  /**
   * --- 1. INISIALISASI HALAMAN ---
   * Dijalankan otomatis saat HTML selesai dimuat.
   */
  window.onload = function() {
    // Validasi sesi lokal
    if(!token) { logout(); return; }

    // Meminta nama guru dan opsi tahun dari server backend
    google.script.run.withSuccessHandler(res => {
       if(res.success) {
         document.getElementById('guruName').innerText = res.user.nama || "Guru Pembimbing";
         initYearDropdown(); // Lanjutkan mengisi filter tahun
       } else {
         logout(); // Jika token invalid/kadaluarsa dari server
       }
    }).api('getDashboardData', {token: token});
  };

  /**
   * --- 2. SETUP DROPDOWN FILTER TAHUN ---
   * Mengambil data tahun (angkatan) siswa yang tersedia di database.
   */
  function initYearDropdown() {
      google.script.run.withSuccessHandler(res => {
          if(res.success) {
              const years = res.years;
              let opts = '<option value="">Semua</option>'; 
              
              if (years.length > 0) {
                  years.forEach(y => { opts += `<option value="${y}">${y}</option>`; });
              } else {
                  opts = '<option value="">0 Data</option>';
              }
              
              const sel = document.getElementById('filterTahun');
              sel.innerHTML = opts;
              
              // Set nilai default dropdown ke tahun terbaru
              if(years.length > 0) sel.value = years[0]; 

              // Setelah filter siap, ambil data siswa binaan
              loadMyStudents();
          }
      }).api('teacherGetYears', {token: token});
  }

  /**
   * --- 3. MEMUAT DAFTAR SISWA BINAAN GURU TSB ---
   * Mengambil data daftar siswa di mana guru ini di-set sebagai pembimbingnya.
   * Mendukung filterisasi berdasarkan Tahun.
   */
  function loadMyStudents() {
    const yr = document.getElementById('filterTahun').value;
    const div = document.getElementById('studentList');
    
    // Tampilkan animasi loading
    div.innerHTML = '<div class="text-center py-4 text-muted"><span class="spinner-border spinner-border-sm"></span></div>';

    google.script.run.withSuccessHandler(res => {
       // Penanganan jika guru belum memiliki siswa bimbingan
       if(res.list.length === 0) {
         div.innerHTML = '<div class="p-4 text-danger text-center small">Belum ada siswa bimbingan.</div>';
         return;
       }
       
       let html = '';
       res.list.forEach(s => {
         // Tambahkan label tahun kecil di samping nama siswa
         let thnInfo = s.tahun ? `<span class="badge bg-light text-secondary border ms-1">${s.tahun}</span>` : '';
         html += `
           <div class="student-item" onclick="openStudent('${s.nisn}', '${s.nama}', this)">
             <div class="fw-bold text-dark">${s.nama} ${thnInfo}</div>
             <div class="small text-muted">${s.nisn} â€¢ ${s.jurusan}</div>
           </div>
         `;
       });
       div.innerHTML = html;
    }).api('getMyStudents', {token: token, targetYear: yr});
  }

  /**
   * --- 4. BUKA LOGBOOK SISWA (EVENT ONCLICK) ---
   * Mengubah area konten utama untuk menampilkan detail jurnal dari siswa yang dipilih.
   * @param {string} nisn - Nomor Induk Siswa.
   * @param {string} nama - Nama Lengkap Siswa.
   * @param {element} el - Elemen HTML list siswa yang di-klik.
   */
  function openStudent(nisn, nama, el) {
    // Styling: Buat elemen yang diklik memiliki background biru muda (active state)
    document.querySelectorAll('.student-item').forEach(e => e.classList.remove('active'));
    el.classList.add('active');
    
    currentStudentNisn = nisn;
    
    // Setup UI Konten
    document.getElementById('selectedStudent').innerText = nama;
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('logContainer').style.display = 'flex';
    
    // Jika sedang menggunakan mobile device, sembunyikan otomatis sidebar setelah memilih siswa
    if(window.innerWidth <= 768) toggleSidebar(); 
    
    // Tampilkan loading di area logbook
    document.getElementById('logsArea').innerHTML = '<div class="text-center py-5"><span class="spinner-border text-primary"></span><br>Mengambil data...</div>';
    
    // Panggil fungsi tarik data logbook
    loadLogs(nisn);
  }
  
  // Fungsi Khusus Mobile: Mengembalikan tampilan konten ke kondisi kosong (Empty State)
  function backToEmpty() {
      document.getElementById('logContainer').style.display = 'none';
      document.getElementById('emptyState').style.display = 'flex';
      // Hapus highlight state pada sidebar
      document.querySelectorAll('.student-item').forEach(e => e.classList.remove('active'));
  }

  /**
   * --- 5. MEMUAT DATA LOGBOOK SPESIFIK SISWA ---
   * Mengambil dan merender JSON Logbook dari server ke dalam susunan Card UI.
   * @param {string} nisn - NISN target siswa.
   */
  function loadLogs(nisn) {
    google.script.run.withSuccessHandler(res => {
       const area = document.getElementById('logsArea');
       
       if(!res.success) {
          area.innerHTML = `<div class="alert alert-danger text-center small">${res.error}</div>`;
          return;
       }
       
       // Handle state jika siswa sama sekali belum pernah membuat entri logbook
       if(res.list.length === 0) {
          area.innerHTML = '<div class="alert alert-info text-center">Siswa ini belum mengisi logbook.</div>';
          return;
       }
       
       let html = '';
       res.list.forEach(l => {
         // Render Foto Bukti Jika Ada
         let imgHtml = l.foto ? `<img src="${l.foto}" class="w-100 rounded mt-2 mb-2" style="max-height: 250px; object-fit: contain; background:#f8f9fa; border:1px solid #ddd;">` : '';
         
         // Logika Feedback (Catatan Guru):
         // Jika sudah pernah diberi catatan -> Munculkan catatan.
         // Jika belum (kosong) -> Munculkan Tombol 'Beri Catatan' (ACC).
         let feedbackDisplay = l.feedback ? 
            `<div class="alert alert-success p-2 mt-3 mb-0 small"><i class="bi bi-check-circle-fill"></i> <b>Catatan Anda:</b><br>${l.feedback}</div>` : 
            `<button onclick="addFeedback('${l.id}')" class="btn btn-sm btn-outline-primary mt-3 w-100"><i class="bi bi-chat-left-text"></i> Beri Catatan</button>`;
         
         html += `
           <div class="log-card">
             <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2">
                <span class="badge bg-secondary" style="font-size:0.9rem;">${l.tanggal}</span>
                <span class="fw-bold text-muted small"><i class="bi bi-clock"></i> ${l.jam}</span>
             </div>
             
             <h6 class="fw-bold text-primary mb-2">${l.judul}</h6>
             <div class="bg-light p-3 rounded mb-2 border">
                <p class="mb-0 text-dark small" style="white-space: pre-line;">${l.deskripsi}</p>
             </div>
             
             ${imgHtml}
             ${feedbackDisplay}
           </div>
         `;
       });
       area.innerHTML = html;
       
    }).api('getStudentLogbooks', {token: token, targetNisn: nisn});
  }

  /**
   * --- 6. PROSES MEMBERIKAN FEEDBACK GURU ---
   * Membuka popup input (SweetAlert) bagi guru untuk menulis catatan ACC.
   * @param {string} logId - ID Logbook (UUID).
   */
  function addFeedback(logId) {
    Swal.fire({
      title: 'Catatan Guru',
      input: 'textarea',
      inputPlaceholder: 'Tulis tanggapan atau persetujuan Anda...',
      showCancelButton: true,
      confirmButtonText: 'Simpan',
      confirmButtonColor: '#0d6efd'
    }).then((result) => {
      // Pastikan user menekan konfirmasi dan teks tidak kosong
      if (result.isConfirmed && result.value) {
        Swal.showLoading();
        google.script.run.withSuccessHandler(res => {
          if(res.success) {
            Swal.fire('Berhasil', 'Catatan tersimpan.', 'success');
            // Muat ulang daftar logbook untuk siswa yang sedang aktif dilihat
            loadLogs(currentStudentNisn);
          } else {
            Swal.fire('Gagal', res.error, 'error');
          }
        }).api('saveFeedback', {token: token, id: logId, feedback: result.value});
      }
    });
  }

  /**
   * --- 7. GANTI PASSWORD AKUN GURU ---
   * Fungsi privasi untuk guru mengubah password mereka sendiri.
   */
  function changePassGuru() {
    Swal.fire({
      title: 'Ganti Password',
      html: `
        <div class="mb-2 text-start">
           <small class="fw-bold">Password Baru</small>
           <input type="password" id="newPass" class="form-control text-center" placeholder="Minimal 6 karakter">
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: 'Simpan',
      confirmButtonColor: '#0d6efd',
      preConfirm: () => {
        const p = document.getElementById('newPass').value;
        if (!p || p.length < 6) Swal.showValidationMessage('Password minimal 6 karakter');
        return p;
      }
    }).then((result) => {
      if (result.isConfirmed) {
        Swal.fire({ title: 'Menyimpan...', didOpen: () => Swal.showLoading() });
        
        google.script.run.withSuccessHandler(res => {
           if(res.success) {
              Swal.fire('Berhasil', 'Password Anda telah diperbarui.', 'success');
           } else {
              Swal.fire('Gagal', res.error, 'error');
           }
        }).api('teacherChangePass', { token: token, newPass: result.value });
      }
    });
  }

  /**
   * --- 8. FUNGSI LOGOUT (KEAMANAN SESI) ---
   * Menghapus variabel LocalStorage di browser dan meredirect secara aman
   * ke halaman awal login menggunakan URL bersih yang di-fetch dari server.
   */
  function logout() {
    Swal.fire({
      title: 'Keluar?',
      text: "Sesi Anda akan berakhir.",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Ya, Logout'
    }).then((result) => {
      if (result.isConfirmed) {
        // Hapus token akses dari memori browser
        localStorage.clear();
        
        Swal.fire({ 
            title: 'Keluar...', 
            text: 'Mengalihkan ke halaman login.',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading() } 
        });
        
        // Panggil server untuk mendapatkan Base URL App dan redirect paksa
        google.script.run.withSuccessHandler(baseUrl => {
            const link = document.createElement('a');
            link.href = baseUrl;
            link.target = '_top'; // Memaksa buka di frame parent teratas (keluar iframe GAS)
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }).getAppUrl();
      }
    });
  }
</script>

</body>
</html>
